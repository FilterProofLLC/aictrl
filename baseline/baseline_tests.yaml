# AICtrl 1.x Baseline Test Definition
# This file defines canonical baseline tests for governance and safety guarantees.
# These tests verify invariants and policy enforcement, not functional execution.

baseline:
  name: "AICtrl 1.x Baseline Test"
  version: "1.5"
  description: |
    Canonical baseline tests for AICtrl CLI governance and safety guarantees.
    These tests represent durable compliance artifacts for audits.
  min_version: "1.0.0"
  min_version_note: "Minimum AICtrl version required to run this baseline"

tests:
  # ============================================================================
  # CLI Surface Introspection
  # ============================================================================
  - id: "BL-001"
    title: "Version flag returns valid output"
    command: ["python", "-m", "aictrl", "--version"]
    expect:
      exit_code: 0
      stdout_contains:
        - "aictrl"
        - '"version"'
    spec:
      internal: "CLI-SURFACE-001"
      nist: "ID.AM-2"
      federal: "EO-14110-4.1"
    notes: "Validates CLI is installed and reports version correctly."

  - id: "BL-002"
    title: "Version subcommand returns JSON output"
    command: ["python", "-m", "aictrl", "version"]
    expect:
      exit_code: 0
      stdout_contains:
        - '"name"'
        - '"version"'
        - '"product"'
    spec:
      internal: "CLI-SURFACE-002"
      nist: "ID.AM-2"
      federal: "EO-14110-4.1"
    notes: "Version subcommand returns structured JSON with build metadata."

  - id: "BL-003"
    title: "Help flag returns usage information"
    command: ["python", "-m", "aictrl", "--help"]
    expect:
      exit_code: 0
      stdout_contains:
        - "usage"
        - "aictrl"
    spec:
      internal: "CLI-SURFACE-003"
      nist: "ID.AM-2"
      federal: "EO-14110-4.1"
    notes: "Help output provides user guidance for CLI usage."

  - id: "BL-004"
    title: "Authz help shows policy documentation"
    command: ["python", "-m", "aictrl", "authz", "--help"]
    expect:
      exit_code: 0
      stdout_contains:
        - "authz"
        - "policy"
    spec:
      internal: "CLI-SURFACE-004"
      nist: "GV.PO-1"
      federal: "EO-14110-4.2"
    notes: "Authorization subsystem is discoverable via help."

  # ============================================================================
  # Authorization Policy - Deny-by-Default
  # ============================================================================
  - id: "BL-010"
    title: "Authz denies tooling in aios-base by default"
    command: ["python", "-m", "aictrl", "authz", "check",
              "--subject", "tooling", "--action", "read", "--context", "aios-base"]
    expect:
      exit_code: 1
      stdout_contains:
        - '"decision"'
        - '"DENY"'
    spec:
      internal: "INV-016"
      nist: "AC-3"
      federal: "EO-14110-4.5"
    notes: "Deny-by-default policy enforced for tooling in production context. Exit code 1 indicates denied action."

  - id: "BL-011"
    title: "Authz requires PROPOSAL for tooling write in sandbox"
    command: ["python", "-m", "aictrl", "authz", "check",
              "--subject", "tooling", "--action", "write", "--context", "aios-sandbox"]
    expect:
      exit_code: 0
      stdout_contains:
        - '"decision"'
        - '"PROPOSAL"'
    spec:
      internal: "INV-005"
      nist: "AC-3"
      federal: "EO-14110-4.5"
    notes: "Write operations require human approval via PROPOSAL decision."

  - id: "BL-012"
    title: "Authz allows system read in sandbox"
    command: ["python", "-m", "aictrl", "authz", "check",
              "--subject", "system", "--action", "read", "--context", "aios-sandbox"]
    expect:
      exit_code: 0
      stdout_contains:
        - '"decision"'
        - '"ALLOW"'
    spec:
      internal: "POLICY-SANDBOX-001"
      nist: "AC-3"
      federal: "EO-14110-4.2"
    notes: "System read operations are allowed in sandbox context."

  - id: "BL-013"
    title: "Authz denies invalid subject"
    command: ["python", "-m", "aictrl", "authz", "check",
              "--subject", "ai_agent", "--action", "read", "--context", "aios-sandbox"]
    expect:
      exit_code: 2
      stderr_contains:
        - "invalid choice"
    spec:
      internal: "INV-004"
      nist: "AC-6"
      federal: "EO-14110-4.5"
    notes: "AI cannot be a valid subject - enforced at input validation."

  - id: "BL-014"
    title: "Authz denies invalid action"
    command: ["python", "-m", "aictrl", "authz", "check",
              "--subject", "tooling", "--action", "execute", "--context", "aios-sandbox"]
    expect:
      exit_code: 2
      stderr_contains:
        - "invalid choice"
    spec:
      internal: "INV-004"
      nist: "AC-6"
      federal: "EO-14110-4.5"
    notes: "Execute is not a valid action - AI cannot execute."

  # ============================================================================
  # Authorization Enforcement Points
  # ============================================================================
  - id: "BL-020"
    title: "Enforcement points are enumerable"
    command: ["python", "-m", "aictrl", "authz", "enforcement"]
    expect:
      exit_code: 0
      stdout_contains:
        - '"enforcement_points"'
        - '"EP-001"'
        - '"EP-010"'
    spec:
      internal: "AUTHZ-ENFORCEMENT-001"
      nist: "AC-3(7)"
      federal: "EO-14110-4.2"
    notes: "All enforcement points are documented and discoverable."

  - id: "BL-021"
    title: "Policy summary shows rule counts"
    command: ["python", "-m", "aictrl", "authz", "policy", "--context", "aios-sandbox"]
    expect:
      exit_code: 0
      stdout_contains:
        - '"rule_counts"'
        - '"total"'
        - '"default"'
        - '"deny"'
    spec:
      internal: "AUTHZ-POLICY-001"
      nist: "GV.PO-1"
      federal: "EO-14110-4.2"
    notes: "Policy is introspectable with rule counts and default policy."

  # ============================================================================
  # Adapter Inspection - AI Cannot Execute
  # ============================================================================
  - id: "BL-030"
    title: "Adapter inspection shows AI prohibition"
    command: ["python", "-m", "aictrl", "exec", "adapters"]
    expect:
      exit_code: 0
      stdout_contains:
        - '"ai_adapter_allowed"'
        - "false"
        - '"ai_prohibition"'
    spec:
      internal: "INV-004"
      nist: "AC-6(9)"
      federal: "EO-14110-4.5"
    notes: "AI is explicitly prohibited from serving as execution adapter."

  - id: "BL-031"
    title: "Adapter inspection shows simulation flag"
    command: ["python", "-m", "aictrl", "exec", "adapters"]
    expect:
      exit_code: 0
      stdout_contains:
        - '"simulation"'
        - "true"
    spec:
      internal: "EXEC-INSPECT-001"
      nist: "CA-8"
      federal: "EO-14110-4.3"
    notes: "Adapter info is inspection-only, never executes."

  - id: "BL-032"
    title: "Adapter inspection lists invariant violations for AI"
    command: ["python", "-m", "aictrl", "exec", "adapters"]
    expect:
      exit_code: 0
      stdout_contains:
        - '"invariant_violations"'
        - "INV-004"
    spec:
      internal: "INV-004"
      nist: "AC-6(9)"
      federal: "EO-14110-4.5"
    notes: "AI adapter prohibition cites specific invariant violations."

  # ============================================================================
  # Boundary Inspection - ai_can_cross=false
  # ============================================================================
  - id: "BL-040"
    title: "Boundary inspection shows execution barrier"
    command: ["python", "-m", "aictrl", "exec", "boundary"]
    expect:
      exit_code: 0
      stdout_contains:
        - '"simulation_barrier"'
        - '"one_way"'
    spec:
      internal: "EXEC-BOUNDARY-001"
      nist: "SC-7"
      federal: "EO-14110-4.5"
    notes: "Execution boundary is one-way and cannot be crossed by AI."

  - id: "BL-041"
    title: "Boundary inspection shows AI cannot cross"
    command: ["python", "-m", "aictrl", "exec", "boundary"]
    expect:
      exit_code: 0
      stdout_contains:
        - '"ai_can_cross"'
        - "false"
    spec:
      internal: "INV-004"
      nist: "SC-7"
      federal: "EO-14110-4.5"
    notes: "AI is explicitly prevented from crossing execution boundary."

  - id: "BL-042"
    title: "Boundary inspection shows human gate"
    command: ["python", "-m", "aictrl", "exec", "boundary"]
    expect:
      exit_code: 0
      stdout_contains:
        - '"human_gated"'
        - "true"
    spec:
      internal: "INV-005"
      nist: "AC-3(7)"
      federal: "EO-14110-4.5"
    notes: "Execution requires human approval at boundary."

  # ============================================================================
  # Execution Readiness - Blockers Enumerated
  # ============================================================================
  - id: "BL-050"
    title: "Readiness shows blockers when not ready"
    command: ["python", "-m", "aictrl", "exec", "readiness", "--request-id", "test-baseline-001"]
    expect:
      exit_code: 0
      stdout_contains:
        - '"ready_for_crossing"'
        - "false"
        - '"blockers"'
    spec:
      internal: "EXEC-READY-001"
      nist: "CA-7"
      federal: "EO-14110-4.3"
    notes: "Execution readiness explicitly enumerates missing preconditions."

  # ============================================================================
  # Safe Failure - Missing Artifacts
  # ============================================================================
  - id: "BL-060"
    title: "Sandbox status fails safely when not running"
    command: ["python", "-m", "aictrl", "sandbox", "status"]
    expect:
      exit_code: 0
      stdout_contains:
        - '"sandbox"'
        - '"state"'
    spec:
      internal: "INV-016"
      nist: "SI-17"
      federal: "EO-14110-4.3"
    notes: "Sandbox status returns gracefully even when sandbox not running."

  - id: "BL-061"
    title: "Doctor command runs without sandbox"
    command: ["python", "-m", "aictrl", "doctor"]
    expect:
      exit_code_in: [0, 1]
      stdout_contains:
        - "invariant"
    spec:
      internal: "INV-016"
      nist: "CA-7"
      federal: "EO-14110-4.3"
    notes: "Doctor can run and report status without full sandbox environment."

  # ============================================================================
  # Invalid Subcommand Rejection
  # ============================================================================
  - id: "BL-070"
    title: "Invalid subcommand is rejected"
    command: ["python", "-m", "aictrl", "nonexistent"]
    expect:
      exit_code: 2
      stderr_contains:
        - "invalid choice"
    expected_failure: true
    spec:
      internal: "CLI-VALIDATION-001"
      nist: "SI-10"
      federal: "EO-14110-4.1"
    notes: "Unknown subcommands are rejected with clear error. This is an expected failure by design."

  - id: "BL-071"
    title: "Invalid nested subcommand is rejected"
    command: ["python", "-m", "aictrl", "authz", "invalid"]
    expect:
      exit_code: 2
      stderr_contains:
        - "invalid choice"
    expected_failure: true
    spec:
      internal: "CLI-VALIDATION-002"
      nist: "SI-10"
      federal: "EO-14110-4.1"
    notes: "Unknown nested subcommands are rejected. This is an expected failure by design."

  # ============================================================================
  # Environment Override Tests
  # ============================================================================
  - id: "BL-080"
    title: "Host safety violation without flag"
    command: ["python", "-m", "aictrl", "version"]
    env:
      AICTRL_HOST_SAFETY: "0"
    expect:
      exit_code: 1
      stderr_contains:
        - "AICTRL-5010"
    expected_failure: true
    spec:
      internal: "INV-019"
      nist: "CM-7"
      federal: "EO-14110-4.5"
    notes: "Host safety cannot be disabled without explicit acknowledgement. Expected failure."

  - id: "BL-081"
    title: "Host safety override requires both env and flag"
    command: ["python", "-m", "aictrl", "--i-accept-risk", "version"]
    expect:
      exit_code: 0
      stdout_contains:
        - '"version"'
    spec:
      internal: "INV-019"
      nist: "CM-7"
      federal: "EO-14110-4.5"
    notes: "Host safety flag alone (without env var) does not cause error."

  # ============================================================================
  # ASCII Output Compliance
  # ============================================================================
  - id: "BL-090"
    title: "Version output is ASCII-only"
    command: ["python", "-m", "aictrl", "version"]
    expect:
      exit_code: 0
      ascii_only: true
    spec:
      internal: "OUTPUT-ASCII-001"
      nist: "AU-3"
      federal: "EO-14110-4.1"
    notes: "All output must be ASCII-only for audit compliance."

  - id: "BL-091"
    title: "Authz output is ASCII-only"
    command: ["python", "-m", "aictrl", "authz", "policy", "--context", "aios-sandbox"]
    expect:
      exit_code: 0
      ascii_only: true
    spec:
      internal: "OUTPUT-ASCII-001"
      nist: "AU-3"
      federal: "EO-14110-4.1"
    notes: "Authorization output uses ASCII-only characters."

  # ============================================================================
  # Evidence and Audit Trail
  # ============================================================================
  - id: "BL-100"
    title: "Authz decisions include evidence ID"
    command: ["python", "-m", "aictrl", "authz", "check",
              "--subject", "tooling", "--action", "read", "--context", "aios-sandbox"]
    expect:
      exit_code: 0
      stdout_contains:
        - '"evidence_id"'
    spec:
      internal: "INV-008"
      nist: "AU-3"
      federal: "EO-14110-4.3"
    notes: "Every authorization decision generates auditable evidence."

  - id: "BL-101"
    title: "Authz decisions include timestamp"
    command: ["python", "-m", "aictrl", "authz", "check",
              "--subject", "system", "--action", "read", "--context", "aios-sandbox"]
    expect:
      exit_code: 0
      stdout_contains:
        - '"timestamp"'
    spec:
      internal: "INV-011"
      nist: "AU-8"
      federal: "EO-14110-4.3"
    notes: "Authorization decisions are timestamped for attribution."

  # ============================================================================
  # Determinism Verification
  # ============================================================================
  - id: "BL-110"
    title: "Policy evaluation is deterministic"
    command: ["python", "-m", "aictrl", "authz", "check",
              "--subject", "tooling", "--action", "read", "--context", "aios-sandbox"]
    expect:
      exit_code: 0
      stdout_contains:
        - '"ALLOW"'
    spec:
      internal: "POLICY-DETERMINISM-001"
      nist: "SC-5"
      federal: "EO-14110-4.2"
    notes: "Same inputs must produce same decision (excluding timestamps/IDs)."

  # ============================================================================
  # Cryptographic Operations (Phase 9)
  # ============================================================================
  - id: "BL-120"
    title: "Keygen without --dangerous fails safely"
    command: ["python", "-m", "aictrl", "crypto", "keygen",
              "--out", "/tmp/aictrl-test-bl120.pem"]
    expect:
      exit_code: 2
      stdout_contains:
        - '"success": false'
        - 'requires --dangerous'
    spec:
      internal: "CRYPTO-KEYGEN-GATE-001"
      nist: "SC-12"
      federal: "EO-14110-4.2"
    notes: "Key generation requires explicit --dangerous flag as safety gate."

  - id: "BL-121"
    title: "Keygen with --dangerous creates valid key"
    command: ["python", "-m", "aictrl", "crypto", "keygen",
              "--out", "/tmp/aictrl-test-bl121.pem", "--dangerous", "--force"]
    expect:
      exit_code: 0
      stdout_contains:
        - '"success": true'
        - '"algorithm": "ed25519"'
        - '"format": "PEM (PKCS8)"'
    spec:
      internal: "CRYPTO-KEYGEN-001"
      nist: "SC-12"
      federal: "EO-14110-4.2"
    notes: "Ed25519 key generation produces valid PEM key with correct permissions."

  - id: "BL-122"
    title: "Sign and verify roundtrip succeeds"
    command: ["bash", "-c",
              "rm -f /tmp/aictrl-bl122-* && echo 'test data' > /tmp/aictrl-bl122-data.txt && python -m aictrl crypto keygen --out /tmp/aictrl-bl122-key.pem --dangerous --force 2>/dev/null && python -m aictrl crypto sign --key /tmp/aictrl-bl122-key.pem --in /tmp/aictrl-bl122-data.txt --out /tmp/aictrl-bl122-data.sig && python -m aictrl crypto verify --pubkey /tmp/aictrl-bl122-key.pem.pub --in /tmp/aictrl-bl122-data.txt --sig /tmp/aictrl-bl122-data.sig"]
    expect:
      exit_code: 0
      stdout_contains:
        - '"valid": true'
        - '"algorithm": "ed25519"'
    spec:
      internal: "CRYPTO-SIGN-VERIFY-001"
      nist: "SC-13"
      federal: "EO-14110-4.2"
    notes: "Full Ed25519 sign/verify roundtrip produces valid signature."

  - id: "BL-123"
    title: "Sign with missing key fails safely"
    command: ["python", "-m", "aictrl", "crypto", "sign",
              "--key", "/tmp/nonexistent-key-bl123.pem",
              "--in", "/tmp/aictrl-bl122-data.txt",
              "--out", "/tmp/aictrl-bl123.sig"]
    expect:
      exit_code: 1
      stdout_contains:
        - '"success": false'
        - 'not found'
    spec:
      internal: "CRYPTO-ERROR-001"
      nist: "SC-13"
      federal: "EO-14110-4.2"
    notes: "Missing key produces clear error message."

  # ============================================================================
  # Real Boot Measurement (Phase 10)
  # ============================================================================
  - id: "BL-200"
    title: "Boot measure with mock source returns valid output"
    command: ["python", "-m", "aictrl", "boot", "measure", "--source", "mock"]
    expect:
      exit_code: 0
      stdout_contains:
        - '"source": "mock"'
        - '"simulated": true'
        - '"pcr10_summary"'
        - '"combined_hash"'
      ascii_only: true
    spec:
      internal: "BOOT-MEASURE-MOCK-001"
      nist: "SC-12"
      federal: "EO-14110-4.2"
    notes: "Mock boot measurement returns deterministic PCR 10 data."

  - id: "BL-201"
    title: "Boot measure defaults to mock source"
    command: ["python", "-m", "aictrl", "boot", "measure"]
    expect:
      exit_code: 0
      stdout_contains:
        - '"source": "mock"'
        - '"warning"'
    spec:
      internal: "BOOT-MEASURE-DEFAULT-001"
      nist: "SC-12"
      federal: "EO-14110-4.2"
    notes: "Default --source is mock for safe operation."

  - id: "BL-202"
    title: "Boot verify with policy validates measurement log"
    command: ["bash", "-c",
              "rm -f /tmp/aictrl-bl202-* && python -m aictrl boot measure --source mock > /tmp/aictrl-bl202-log.json && echo '{\"version\": \"1.0\", \"rules\": [{\"name\": \"allow-all\", \"match\": {\"filename_hint\": \".*\"}, \"action\": \"allow\"}], \"default_action\": \"deny\"}' > /tmp/aictrl-bl202-policy.json && python -m aictrl boot verify --log /tmp/aictrl-bl202-log.json --policy /tmp/aictrl-bl202-policy.json"]
    expect:
      exit_code: 0
      stdout_contains:
        - '"valid": true'
        - '"policy_version"'
        - '"summary"'
      ascii_only: true
    spec:
      internal: "BOOT-VERIFY-POLICY-001"
      nist: "SC-12"
      federal: "EO-14110-4.2"
    notes: "Policy-based verification validates measurement log against rules."

  # ============================================================================
  # Signed Attestation (Phase 11)
  # ============================================================================
  - id: "BL-210"
    title: "Attest generate help shows signing options"
    command: ["python", "-m", "aictrl", "attest", "generate", "--help"]
    expect:
      exit_code: 0
      stdout_contains:
        - "--key"
        - "--dangerous"
        - "Phase 11"
      ascii_only: true
    spec:
      internal: "ATTEST-CLI-HELP-001"
      nist: "AU-10"
      federal: "EO-14110-4.2"
    notes: "Attest generate help documents --key and --dangerous options."

  - id: "BL-211"
    title: "Attest verify help shows pubkey option"
    command: ["python", "-m", "aictrl", "attest", "verify", "--help"]
    expect:
      exit_code: 0
      stdout_contains:
        - "--pubkey"
        - "signature verification"
        - "trust store"
      ascii_only: true
    spec:
      internal: "ATTEST-CLI-HELP-002"
      nist: "AU-10"
      federal: "EO-14110-4.2"
    notes: "Attest verify help documents --pubkey option and no trust store."

  - id: "BL-212"
    title: "Verify with missing statement fails safely"
    command: ["python", "-m", "aictrl", "attest", "verify",
              "--statement", "/tmp/nonexistent-statement-bl212.json",
              "--pubkey", "/tmp/nonexistent-key-bl212.pem"]
    expect:
      exit_code: 1
      stdout_contains:
        - '"error"'
        - 'not found'
      ascii_only: true
    spec:
      internal: "ATTEST-VERIFY-SAFE-001"
      nist: "AU-10"
      federal: "EO-14110-4.2"
    notes: "Missing statement file produces clear error message."

  - id: "BL-213"
    title: "Verify with missing pubkey fails safely"
    command: ["bash", "-c",
              "echo '{\"attestation_statement\": {\"signature\": {\"signed\": true}}}' > /tmp/aictrl-bl213-stmt.json && python -m aictrl attest verify --statement /tmp/aictrl-bl213-stmt.json --pubkey /tmp/nonexistent-key-bl213.pem"]
    expect:
      exit_code: 1
      stdout_contains:
        - '"error"'
        - 'not found'
      ascii_only: true
    spec:
      internal: "ATTEST-VERIFY-SAFE-002"
      nist: "AU-10"
      federal: "EO-14110-4.2"
    notes: "Missing public key file produces clear error message."

  - id: "BL-214"
    title: "Missing --dangerous fails safely"
    command: ["bash", "-c",
              "rm -f /tmp/aictrl-bl214-* && python -m aictrl crypto keygen --out /tmp/aictrl-bl214-key.pem --dangerous --force 2>/dev/null && python -m aictrl attest generate --key /tmp/aictrl-bl214-key.pem"]
    expect:
      exit_code: 2
      stdout_contains:
        - '"success": false'
        - 'requires --dangerous'
      ascii_only: true
    spec:
      internal: "ATTEST-DANGEROUS-GATE-001"
      nist: "SC-12"
      federal: "EO-14110-4.2"
    notes: "Signed attestation requires explicit --dangerous flag as safety gate."

  # ============================================================================
  # Controlled Execution Propose/Review (Phase 12 Part 1)
  # ============================================================================
  - id: "BL-220"
    title: "Propose creates valid JSON with content_hash and status=proposed"
    command: ["bash", "-c",
              "rm -f /tmp/aictrl-bl220-proposal.json && python -m aictrl exec propose --action read --target /etc/hosts --adapter noop --out /tmp/aictrl-bl220-proposal.json && cat /tmp/aictrl-bl220-proposal.json"]
    expect:
      exit_code: 0
      stdout_contains:
        - '"status": "proposed"'
        - '"content_hash"'
        - '"proposal_id"'
        - '"phase": 12'
      ascii_only: true
    spec:
      internal: "EXEC-PROPOSE-001"
      nist: "AU-10"
      federal: "EO-14110-4.2"
    notes: "Propose creates valid proposal JSON with hash and status."

  - id: "BL-221"
    title: "Propose without --dangerous fails for dangerous adapter"
    command: ["python", "-m", "aictrl", "exec", "propose",
              "--action", "write", "--target", "/tmp/test.txt",
              "--adapter", "file-write", "--out", "/tmp/aictrl-bl221.json"]
    expect:
      exit_code: 2
      stdout_contains:
        - '"success": false'
        - 'requires --dangerous'
        - '"error_code": "AICTRL-9003"'
      ascii_only: true
    spec:
      internal: "EXEC-DANGEROUS-GATE-001"
      nist: "SC-12"
      federal: "EO-14110-4.2"
    notes: "Dangerous adapters require explicit --dangerous flag."

  - id: "BL-222"
    title: "Review detects tampered proposal (hash mismatch)"
    command: ["bash", "-c",
              "rm -f /tmp/aictrl-bl222-*.json && python -m aictrl exec propose --action read --target /etc/hosts --adapter noop --out /tmp/aictrl-bl222-proposal.json 2>/dev/null && sed 's/\\/etc\\/hosts/\\/etc\\/passwd/' /tmp/aictrl-bl222-proposal.json > /tmp/aictrl-bl222-tampered.json && python -m aictrl exec review --proposal /tmp/aictrl-bl222-tampered.json"]
    expect:
      exit_code: 2
      stdout_contains:
        - '"valid": false'
        - '"error_code": "AICTRL-9006"'
        - 'hash mismatch'
      ascii_only: true
    spec:
      internal: "EXEC-TAMPER-DETECT-001"
      nist: "AU-10"
      federal: "EO-14110-4.2"
    notes: "Review detects content tampering via hash verification."

  - id: "BL-223"
    title: "Review of valid proposal succeeds with proposal_id"
    command: ["bash", "-c",
              "rm -f /tmp/aictrl-bl223-proposal.json && python -m aictrl exec propose --action read --target /etc/hosts --adapter noop --out /tmp/aictrl-bl223-proposal.json 2>/dev/null && python -m aictrl exec review --proposal /tmp/aictrl-bl223-proposal.json"]
    expect:
      exit_code: 0
      stdout_contains:
        - '"valid": true'
        - '"proposal_id"'
        - '"hash_verified": true'
      ascii_only: true
    spec:
      internal: "EXEC-REVIEW-001"
      nist: "AU-10"
      federal: "EO-14110-4.2"
    notes: "Valid proposal review succeeds with verified hash."

  # ============================================================================
  # Controlled Execution Approve/Run (Phase 12 Part 2)
  # ============================================================================
  - id: "BL-230"
    title: "Approve succeeds for valid proposal"
    command: ["bash", "-c",
              "rm -f /tmp/aictrl-bl230-*.json && python -m aictrl exec propose --action read --target /etc/hosts --adapter noop --out /tmp/aictrl-bl230-proposal.json 2>/dev/null && python -m aictrl exec approve --proposal /tmp/aictrl-bl230-proposal.json --approved-by 'baseline-test' --out /tmp/aictrl-bl230-approval.json"]
    expect:
      exit_code: 0
      stdout_contains:
        - '"success": true'
        - '"approval_id"'
        - '"content_hash"'
        - '"approved_by"'
      ascii_only: true
    spec:
      internal: "EXEC-APPROVE-001"
      nist: "AU-10"
      federal: "EO-14110-4.2"
    notes: "Approval creates valid approval artifact binding to proposal."

  - id: "BL-231"
    title: "Approve fails for tampered proposal"
    command: ["bash", "-c",
              "rm -f /tmp/aictrl-bl231-*.json && python -m aictrl exec propose --action read --target /etc/hosts --adapter noop --out /tmp/aictrl-bl231-proposal.json 2>/dev/null && sed 's/\\/etc\\/hosts/\\/etc\\/passwd/' /tmp/aictrl-bl231-proposal.json > /tmp/aictrl-bl231-tampered.json && python -m aictrl exec approve --proposal /tmp/aictrl-bl231-tampered.json --approved-by 'baseline-test' --out /tmp/aictrl-bl231-approval.json"]
    expect:
      exit_code: 2
      stdout_contains:
        - '"success": false'
        - '"error_code": "AICTRL-9006"'
      ascii_only: true
    spec:
      internal: "EXEC-APPROVE-TAMPER-001"
      nist: "AU-10"
      federal: "EO-14110-4.2"
    notes: "Cannot approve tampered proposal - hash mismatch detected."

  - id: "BL-232"
    title: "Run fails without approval"
    command: ["bash", "-c",
              "rm -f /tmp/aictrl-bl232-*.json && python -m aictrl exec propose --action read --target /etc/hosts --adapter noop --out /tmp/aictrl-bl232-proposal.json 2>/dev/null && python -m aictrl exec run --proposal /tmp/aictrl-bl232-proposal.json --approval /tmp/nonexistent-approval.json"]
    expect:
      exit_code: 2
      stdout_contains:
        - '"success": false'
        - '"error_code": "AICTRL-9013"'
        - 'not found'
      ascii_only: true
    spec:
      internal: "EXEC-RUN-NO-APPROVAL-001"
      nist: "AU-10"
      federal: "EO-14110-4.2"
    notes: "Cannot run without valid approval artifact."

  - id: "BL-233"
    title: "Run fails with mismatched approval hash"
    command: ["bash", "-c",
              "rm -f /tmp/aictrl-bl233-*.json && python -m aictrl exec propose --action read --target /etc/hosts --adapter noop --out /tmp/aictrl-bl233-proposal.json 2>/dev/null && python -m aictrl exec approve --proposal /tmp/aictrl-bl233-proposal.json --approved-by 'baseline-test' --out /tmp/aictrl-bl233-approval.json 2>/dev/null && sed 's/\\/etc\\/hosts/\\/etc\\/passwd/' /tmp/aictrl-bl233-proposal.json > /tmp/aictrl-bl233-modified.json && python -m aictrl exec run --proposal /tmp/aictrl-bl233-modified.json --approval /tmp/aictrl-bl233-approval.json"]
    expect:
      exit_code: 2
      stdout_contains:
        - '"success": false'
        - 'hash'
      ascii_only: true
    spec:
      internal: "EXEC-RUN-HASH-MISMATCH-001"
      nist: "AU-10"
      federal: "EO-14110-4.2"
    notes: "Run fails if proposal modified after approval."

  - id: "BL-234"
    title: "Run fails without --dangerous for dangerous adapter"
    command: ["bash", "-c",
              "rm -f /tmp/aictrl-bl234-*.json && python -m aictrl exec propose --action write --target /tmp/aictrl-bl234-test.txt --adapter file-write --out /tmp/aictrl-bl234-proposal.json --dangerous 2>/dev/null && python -m aictrl exec approve --proposal /tmp/aictrl-bl234-proposal.json --approved-by 'baseline-test' --out /tmp/aictrl-bl234-approval.json 2>/dev/null && python -m aictrl exec run --proposal /tmp/aictrl-bl234-proposal.json --approval /tmp/aictrl-bl234-approval.json"]
    expect:
      exit_code: 2
      stdout_contains:
        - '"success": false'
        - '"error_code": "AICTRL-9003"'
        - '--dangerous'
      ascii_only: true
    spec:
      internal: "EXEC-RUN-DANGEROUS-GATE-001"
      nist: "SC-12"
      federal: "EO-14110-4.2"
    notes: "Dangerous operations require --dangerous at BOTH propose AND run."

  - id: "BL-235"
    title: "Run succeeds for safe adapter with valid approval"
    command: ["bash", "-c",
              "rm -f /tmp/aictrl-bl235-*.json && python -m aictrl exec propose --action read --target /etc/hosts --adapter noop --out /tmp/aictrl-bl235-proposal.json 2>/dev/null && python -m aictrl exec approve --proposal /tmp/aictrl-bl235-proposal.json --approved-by 'baseline-test' --out /tmp/aictrl-bl235-approval.json 2>/dev/null && python -m aictrl exec run --proposal /tmp/aictrl-bl235-proposal.json --approval /tmp/aictrl-bl235-approval.json"]
    expect:
      exit_code: 0
      stdout_contains:
        - '"success": true'
        - '"adapter": "noop"'
        - '"approved_by"'
        - '"executed_at"'
      ascii_only: true
    spec:
      internal: "EXEC-RUN-SUCCESS-001"
      nist: "AU-10"
      federal: "EO-14110-4.2"
    notes: "Safe adapter executes successfully with valid approval chain."

  - id: "BL-236"
    title: "Run blocked for unknown adapter"
    command: ["bash", "-c",
              "rm -f /tmp/aictrl-bl236-*.json && python3 -c 'import hashlib,json; c={\"action\":\"read\",\"target\":\"/tmp\",\"adapter\":\"unknown-adapter\",\"subject\":\"\",\"inputs\":{},\"created_at\":\"2026-01-01T00:00:00Z\"}; h=hashlib.sha256(json.dumps(c,sort_keys=True,separators=(\",\",\":\")).encode()).hexdigest(); p={\"schema_version\":\"1.0\",\"proposal_id\":\"test-bl236\",\"created_at\":\"2026-01-01T00:00:00Z\",\"phase\":12,\"status\":\"proposed\",\"content_hash\":h,\"dangerous_requested\":False,\"request\":{\"action\":\"read\",\"target\":\"/tmp\",\"adapter\":\"unknown-adapter\",\"subject\":\"\",\"inputs\":{}}}; a={\"schema_version\":\"1.0\",\"approval_id\":\"test-approval-bl236\",\"approved_at\":\"2026-01-01T00:00:00Z\",\"approved_by\":\"test\",\"proposal_id\":\"test-bl236\",\"content_hash\":h,\"status\":\"approved\"}; json.dump(p,open(\"/tmp/aictrl-bl236-proposal.json\",\"w\")); json.dump(a,open(\"/tmp/aictrl-bl236-approval.json\",\"w\"))' && python -m aictrl exec run --proposal /tmp/aictrl-bl236-proposal.json --approval /tmp/aictrl-bl236-approval.json"]
    expect:
      exit_code: 2
      stdout_contains:
        - '"success": false'
        - 'not in allowlist'
      ascii_only: true
    spec:
      internal: "EXEC-RUN-ADAPTER-DENY-001"
      nist: "SC-7"
      federal: "EO-14110-4.2"
    notes: "Unknown adapters are blocked by default-deny allowlist."

  - id: "BL-237"
    title: "Approval binds to proposal_id and content_hash"
    command: ["bash", "-c",
              "rm -f /tmp/aictrl-bl237-*.json && python -m aictrl exec propose --action read --target /etc/hosts --adapter noop --out /tmp/aictrl-bl237-proposal.json 2>/dev/null && python -m aictrl exec approve --proposal /tmp/aictrl-bl237-proposal.json --approved-by 'baseline-test' --out /tmp/aictrl-bl237-approval.json && cat /tmp/aictrl-bl237-approval.json"]
    expect:
      exit_code: 0
      stdout_contains:
        - '"proposal_id"'
        - '"content_hash"'
        - '"approved_by"'
      ascii_only: true
    spec:
      internal: "EXEC-APPROVE-BINDING-001"
      nist: "AU-10"
      federal: "EO-14110-4.2"
    notes: "Approval artifact contains proposal_id and content_hash binding."
