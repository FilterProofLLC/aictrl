# Phase 12 Design: Controlled Execution (Human-Gated)

**Status:** Design Only (Not Implemented)
**Phase:** 12
**Author:** AICtrl Team
**Created:** 2026-02-04

## Overview

Phase 12 introduces controlled execution with mandatory human approval gates.
This phase enables AICtrl to propose actions, require explicit human approval,
and execute actions through defined adapters with full audit trails.

Key principle: **Safe by default, audit first.**

The system is designed to prevent any execution without explicit human consent,
ensuring that AI tooling cannot autonomously perform side-effecting operations.

## Goals

1. Enable structured proposal of executable actions
2. Require explicit human approval before any execution
3. Bind policy decisions to proposal content cryptographically
4. Capture complete audit trail of proposal, approval, and execution
5. Support pluggable adapter model for different execution targets
6. Maintain backward compatibility with existing AICtrl commands
7. Ensure all operations fail safely on error

## Non-Goals

Phase 12 explicitly does NOT:

1. **Auto-execute** - No action runs without human approval
2. **Auto-approve** - No implicit or delegated approval
3. **Trust AI proposals** - AI-generated proposals are treated as untrusted input
4. **Modify host state by default** - Read-only inspection is the default mode
5. **Cache approvals** - Each execution requires fresh approval
6. **Provide remote execution** - All execution is local
7. **Implement scheduling** - No deferred or timed execution
8. **Grant network access** - Adapters do not make network calls
9. **Bypass policy** - Policy evaluation is mandatory and binding

## Threat Model

### In Scope

| Threat | Mitigation |
|--------|------------|
| AI attempts autonomous execution | Mandatory approval token from human |
| Proposal tampering after approval | Content hash binding |
| Approval replay | One-time approval tokens with expiry |
| Privilege escalation via adapter | Adapter allowlist and --dangerous gate |
| Audit trail manipulation | Append-only evidence bundles with hashes |
| Policy bypass | Decision binding to proposal hash |

### Out of Scope

| Threat | Reason |
|--------|--------|
| Compromised host OS | Assumed trusted base |
| Malicious human approver | Human is the trust anchor |
| Side-channel attacks | Not in scope for CLI tool |
| Network-based attacks | No network operations |

### Trust Boundaries

```
+-------------------+     +-------------------+     +-------------------+
|   AI Agent        | --> |   AICtrl CLI      | --> |   Human Approver  |
|   (Untrusted)     |     |   (Enforcer)      |     |   (Trust Anchor)  |
+-------------------+     +-------------------+     +-------------------+
                                   |
                                   v
                          +-------------------+
                          |   Adapter         |
                          |   (Constrained)   |
                          +-------------------+
```

## Safety Model

### Default Behavior

The default behavior is **NO execution**:

- `aictrl exec propose` has zero side effects (only writes proposal file)
- `aictrl exec review` is read-only (displays proposal details)
- `aictrl exec run` fails without valid approval

### Execution Requirements

For any execution to proceed, ALL of the following must be true:

1. **Valid proposal_id** - Generated by `exec propose`, not expired
2. **Human approval token** - Obtained out-of-band, bound to proposal hash
3. **Adapter in allowlist** - Adapter must be explicitly permitted
4. **Policy decision bound** - Original policy decision hash matches
5. **Content hash valid** - Proposal content has not been modified
6. **Dangerous gate** - If adapter mutates state, `--dangerous` required

### Dangerous Gate

Adapters that can mutate host state require `--dangerous` flag:

| Adapter | Mutating | Requires --dangerous |
|---------|----------|---------------------|
| file-read | No | No |
| file-write | Yes | Yes |
| shell-readonly | No | No |
| shell-execute | Yes | Yes |
| process-inspect | No | No |
| process-signal | Yes | Yes |

### Read-Only vs Controlled Execution

| Mode | Description | Default |
|------|-------------|---------|
| Inspection | View proposals, review decisions, no execution | Yes |
| Controlled | Execute with full approval chain | No (opt-in) |

### ASCII Safety

All outputs must be ASCII-safe:
- No Unicode in proposal/approval/result JSON
- No control characters except newline
- File paths must be ASCII-compatible

## Proposed CLI Interfaces

### exec propose

Creates a proposal for an action. Zero side effects except writing proposal file.

```
aictrl exec propose \
  --action <action> \
  --target <target> \
  --subject <subject> \
  --adapter <name> \
  [--params <json>] \
  [--out <path>]
```

| Argument | Required | Description |
|----------|----------|-------------|
| --action | Yes | Action verb (read, write, execute, signal) |
| --target | Yes | Target resource path or identifier |
| --subject | Yes | Subject requesting the action |
| --adapter | Yes | Adapter to use for execution |
| --params | No | JSON object with adapter-specific parameters |
| --out | No | Output path for proposal JSON (default: stdout) |

Exit codes:
- 0: Proposal created successfully
- 1: Invalid arguments or policy denied
- 2: Capability not available

### exec review

Displays proposal details in human-readable format. Read-only.

```
aictrl exec review \
  --proposal <path>
```

| Argument | Required | Description |
|----------|----------|-------------|
| --proposal | Yes | Path to proposal JSON file |

Exit codes:
- 0: Review displayed successfully
- 1: Invalid or missing proposal

### exec approve

Records human approval for a proposal. Creates approval artifact.

```
aictrl exec approve \
  --proposal <path> \
  --approver <id> \
  --method <string> \
  [--out <path>]
```

| Argument | Required | Description |
|----------|----------|-------------|
| --proposal | Yes | Path to proposal JSON file |
| --approver | Yes | Approver identifier (human ID) |
| --method | Yes | Approval method (interactive, oob-token, etc.) |
| --out | No | Output path for approval JSON (default: stdout) |

Exit codes:
- 0: Approval recorded successfully
- 1: Invalid proposal or approval method
- 2: Capability not available

### exec run

Executes an approved proposal through the specified adapter.

```
aictrl exec run \
  --proposal <path> \
  --approval <path> \
  --adapter <name> \
  [--dangerous]
```

| Argument | Required | Description |
|----------|----------|-------------|
| --proposal | Yes | Path to proposal JSON file |
| --approval | Yes | Path to approval JSON file |
| --adapter | Yes | Adapter to use (must match proposal) |
| --dangerous | Conditional | Required for mutating adapters |

Exit codes:
- 0: Execution completed successfully
- 1: Execution failed
- 2: Approval invalid or capability not available
- 3: Dangerous gate required but not provided

### exec status

Queries status of a prior execution request.

```
aictrl exec status \
  --request-id <id>
```

| Argument | Required | Description |
|----------|----------|-------------|
| --request-id | Yes | Request ID from exec run |

Exit codes:
- 0: Status retrieved
- 1: Request not found

## Data Model

### proposal.json

```json
{
  "schema_version": "1.0",
  "proposal_id": "uuid-v4",
  "created_at": "ISO-8601-timestamp",
  "expires_at": "ISO-8601-timestamp",
  "content_hash": "sha256-hex",
  "policy_decision": {
    "decision_id": "uuid-v4",
    "decision": "ALLOW|DENY|PROPOSAL",
    "decision_hash": "sha256-hex"
  },
  "request": {
    "action": "read|write|execute|signal",
    "target": "/path/or/resource",
    "subject": "subject-id",
    "context": "execution-context"
  },
  "adapter": {
    "name": "adapter-name",
    "version": "1.0",
    "params": {}
  },
  "canonical_string": "action|target|subject|adapter|params-hash|created_at"
}
```

Fields:
- `content_hash`: SHA-256 of canonical_string
- `policy_decision.decision_hash`: Hash of original policy decision
- `canonical_string`: Deterministic string for signing

### approval.json

```json
{
  "schema_version": "1.0",
  "approval_id": "uuid-v4",
  "proposal_id": "uuid-v4",
  "proposal_hash": "sha256-hex",
  "approver": {
    "id": "approver-identifier",
    "type": "human"
  },
  "issued_at": "ISO-8601-timestamp",
  "expires_at": "ISO-8601-timestamp",
  "approval_method": "interactive|oob-token|signature",
  "approval_token": "base64-encoded-token",
  "conditions": {
    "max_executions": 1,
    "adapter_allowlist": ["adapter-name"]
  }
}
```

Fields:
- `proposal_hash`: Must match proposal's content_hash
- `approval_token`: Placeholder for cryptographic token (Phase 13+)
- `max_executions`: Always 1 (no replay)

### exec_result.json

```json
{
  "schema_version": "1.0",
  "request_id": "uuid-v4",
  "proposal_id": "uuid-v4",
  "approval_id": "uuid-v4",
  "adapter": {
    "name": "adapter-name",
    "version": "1.0"
  },
  "execution": {
    "started_at": "ISO-8601-timestamp",
    "completed_at": "ISO-8601-timestamp",
    "exit_code": 0,
    "status": "success|failure|timeout|aborted"
  },
  "evidence": {
    "before_hash": "sha256-hex",
    "after_hash": "sha256-hex",
    "stdout_policy": "capture|discard|truncate",
    "stderr_policy": "capture|discard|truncate",
    "stdout_hash": "sha256-hex",
    "stderr_hash": "sha256-hex"
  },
  "audit": {
    "proposal_hash": "sha256-hex",
    "approval_hash": "sha256-hex",
    "result_hash": "sha256-hex"
  }
}
```

Fields:
- `evidence.before_hash`: State hash before execution
- `evidence.after_hash`: State hash after execution
- `audit.*_hash`: Chain of hashes for audit trail

## Evidence and Audit Trail

### Artifacts Written

| Artifact | Location | Trigger |
|----------|----------|---------|
| proposal.json | --out or stdout | exec propose |
| approval.json | --out or stdout | exec approve |
| exec_result.json | evidence bundle | exec run |

### Evidence Bundle Integration

Execution results integrate with existing evidence bundle commands:

```
evidence/
  bundle_id.json           # Bundle manifest
  entries/
    proposal_<id>.json     # Proposal artifact
    approval_<id>.json     # Approval artifact
    result_<id>.json       # Execution result
```

### Append-Only Policy

- `exec run` appends to evidence bundle, never overwrites
- Each entry includes hash of previous entry (chain)
- Bundle manifest updated atomically

### Hash Chain

```
proposal_hash -> approval_hash -> result_hash
     |                |                |
     v                v                v
  proposal.json   approval.json   exec_result.json
```

## Approval Workflow

```
1. AI Agent calls: aictrl exec propose ...
   Output: proposal.json with proposal_id and content_hash

2. Human reviews: aictrl exec review --proposal proposal.json
   Output: Human-readable summary of proposed action

3. Human approves: aictrl exec approve --proposal proposal.json \
                     --approver human@example --method interactive
   Output: approval.json with approval_token

4. Execution: aictrl exec run --proposal proposal.json \
                --approval approval.json --adapter <name> [--dangerous]
   Output: exec_result.json appended to evidence bundle

5. Status check: aictrl exec status --request-id <id>
   Output: Execution status and result summary
```

## Adapter Model

### Adapter Interface

Each adapter must implement:

```
interface Adapter:
  name: string
  version: string
  is_mutating: bool

  validate(params: dict) -> Result[None, Error]
  inspect(target: string) -> Result[StateHash, Error]
  execute(action: Action, params: dict) -> Result[Output, Error]
```

### Built-in Adapters (Proposed)

| Adapter | Description | Mutating |
|---------|-------------|----------|
| file-read | Read file contents | No |
| file-write | Write file contents | Yes |
| file-stat | Get file metadata | No |
| shell-readonly | Run command, no mutations | No |
| shell-execute | Run command with mutations | Yes |
| process-list | List processes | No |
| process-signal | Send signal to process | Yes |

### Adapter Allowlist

Adapters must be explicitly allowed in policy:

```json
{
  "exec_policy": {
    "adapter_allowlist": ["file-read", "file-stat", "shell-readonly"],
    "require_dangerous_for": ["file-write", "shell-execute", "process-signal"]
  }
}
```

## Policy Evaluation and Decision Binding

### Policy Flow

```
1. exec propose evaluates policy for (subject, action, target, context)
2. Policy returns ALLOW, DENY, or PROPOSAL
3. Decision is bound to proposal via decision_hash
4. exec run re-validates decision binding before execution
5. If decision_hash mismatch, execution is blocked
```

### Decision Binding

The proposal includes:
- Original policy decision_id
- Hash of the decision at time of proposal
- This prevents policy changes between proposal and execution

### Tamper Detection

If proposal content is modified after creation:
- content_hash will not match canonical_string
- approval.proposal_hash will not match proposal.content_hash
- exec run will fail with exit code 2

## Error Handling and Exit Codes

### Exit Code Semantics

| Code | Meaning |
|------|---------|
| 0 | Success |
| 1 | Failure (invalid input, execution error) |
| 2 | Not authorized (approval invalid, capability missing) |
| 3 | Dangerous gate required |
| 4 | Adapter error |
| 5 | Policy binding failure |

### Error Messages

All error messages must:
- Be ASCII-only
- Include error code (AICTRL-9xxx for Phase 12)
- Include actionable remediation
- Not leak sensitive information

### Error Codes

| Code | Description |
|------|-------------|
| AICTRL-9001 | Proposal validation failed |
| AICTRL-9002 | Approval validation failed |
| AICTRL-9003 | Approval expired |
| AICTRL-9004 | Content hash mismatch |
| AICTRL-9005 | Policy decision binding failed |
| AICTRL-9006 | Adapter not in allowlist |
| AICTRL-9007 | Dangerous gate required |
| AICTRL-9008 | Adapter execution failed |
| AICTRL-9009 | Evidence bundle write failed |

## Test Plan (Design Only)

The following baseline tests will be implemented in Phase 12:

| Test ID | Title | Expected Behavior |
|---------|-------|-------------------|
| BL-220 | Proposal has no side effects | exec propose writes only proposal file, no other changes |
| BL-221 | Run without approval fails | exec run without approval returns exit 2 |
| BL-222 | Run without --dangerous fails for mutating adapter | exec run with file-write without --dangerous returns exit 3 |
| BL-223 | Tampered proposal fails | Modified proposal.content_hash causes exit 5 |
| BL-224 | Adapter allowlist enforced | Adapter not in allowlist returns exit 2 |
| BL-225 | Evidence bundle contains full chain | proposal, approval, result all present with hashes |
| BL-226 | Expired approval fails | Approval past expires_at returns exit 2 |
| BL-227 | Policy binding verified | Mismatched decision_hash returns exit 5 |
| BL-228 | Review is read-only | exec review has no side effects |
| BL-229 | Status returns execution result | exec status with valid request_id returns result |

## Acceptance Criteria

Phase 12 implementation is complete when:

1. **Proposal Generation**
   - `aictrl exec propose --action read --target /etc/hosts --subject test --adapter file-read` returns exit 0
   - Output includes valid proposal_id, content_hash, and policy_decision

2. **Review Display**
   - `aictrl exec review --proposal proposal.json` returns exit 0
   - Output displays human-readable proposal summary

3. **Approval Recording**
   - `aictrl exec approve --proposal proposal.json --approver test --method interactive` returns exit 0
   - Output includes approval_id bound to proposal_hash

4. **Execution Gating**
   - `aictrl exec run --proposal p.json --approval a.json --adapter file-read` returns exit 0 only with valid chain
   - Missing approval returns exit 2
   - Mutating adapter without --dangerous returns exit 3

5. **Evidence Integration**
   - Execution result appears in evidence bundle
   - All hashes form valid chain

6. **Baseline Tests**
   - All BL-220 through BL-229 tests pass

7. **ASCII Compliance**
   - All outputs pass ASCII-only validation

## Backward Compatibility

Phase 12 introduces new commands under `exec` subcommand.
No existing commands are modified.

| Existing Command | Impact |
|------------------|--------|
| aictrl authz * | Unchanged |
| aictrl boot * | Unchanged |
| aictrl attest * | Unchanged |
| aictrl crypto * | Unchanged |
| aictrl evidence * | Extended (new entry types) |

## Open Questions

1. **Approval Token Format**
   - Should approval tokens be cryptographic signatures (Phase 13)?
   - Or simple HMAC for Phase 12?

2. **Adapter Discovery**
   - Should adapters be built-in only?
   - Or support external adapter plugins?

3. **Timeout Handling**
   - How long should approvals be valid?
   - Should there be a maximum execution timeout?

4. **Stdout/Stderr Capture**
   - Full capture vs truncation?
   - Privacy implications of capturing output?

5. **Multi-Approver Scenarios**
   - Is single-approver sufficient for Phase 12?
   - Defer multi-party approval to Phase 13+?

---

*This document is design-only. Implementation will occur in a separate PR.*
